# Judge Consensus Pipeline
#
# Multiple models analyze the code, then a judge model resolves
# conflicts and verifies high-severity findings.
#
# This pipeline provides the highest confidence results by having
# a specialized judge model make final decisions.

name: "judge_consensus"
version: "1.0"
description: "Multi-model analysis with judge-based conflict resolution"
author: "Aegis Team"
tags: ["high-confidence", "judge", "verification"]
is_preset: true

enable_parallelization: true
store_intermediate_results: true

steps:
  # Step 1: Run both triage and deep scan models
  - id: "triage"
    kind: "role"
    role: "triage"
    enabled: true
    timeout_seconds: 300

  - id: "deep_scan"
    kind: "role"
    role: "deep_scan"
    enabled: true
    timeout_seconds: 900

  # Step 2: Initial consensus to identify conflicts
  - id: "initial_consensus"
    kind: "consensus"
    strategy: "majority"
    sources: ["triage", "deep_scan"]

  # Step 3: Gate to check if we need judge (low agreement score)
  - id: "gate_judge"
    kind: "gate"
    condition:
      # Use judge if models disagree (agreement < 70%)
      field: "findings.agreement_score"
      operator: "<"
      value: 0.7
      or_conditions:
        # Also use judge for all critical severity findings
        - field: "findings.critical_count"
          operator: ">"
          value: 0
    on_true: "judge_review"
    on_false: "final_consensus"

  # Step 4: Judge reviews conflicts and critical findings
  - id: "judge_review"
    kind: "role"
    role: "judge"
    enabled: true
    timeout_seconds: 600

  # Step 5: Final consensus with judge input
  - id: "final_consensus"
    kind: "consensus"
    strategy: "judge"
    sources: ["triage", "deep_scan", "judge_review"]
