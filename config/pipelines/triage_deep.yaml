# Triage â†’ Deep Scan Pipeline
#
# Fast triage models screen the code first. If high-severity issues
# are found, escalate to deep scan with more thorough (and expensive) models.
#
# This pipeline reduces API costs by only running expensive models when needed.

name: "triage_deep"
version: "1.0"
description: "Fast triage with conditional deep scan escalation"
author: "Aegis Team"
tags: ["cost-effective", "escalation", "smart"]
is_preset: true

enable_parallelization: true
store_intermediate_results: true  # Store triage results separately

steps:
  # Step 1: Fast triage with lightweight models
  - id: "triage"
    kind: "role"
    role: "triage"
    enabled: true
    timeout_seconds: 300

  # Step 2: Check if triage found any high/critical severity issues
  - id: "gate_escalate"
    kind: "gate"
    condition:
      # Escalate if triage found at least 1 high or critical finding
      field: "step.triage.high_count"
      operator: ">"
      value: 0
      or_conditions:
        - field: "step.triage.critical_count"
          operator: ">"
          value: 0
    on_true: "deep_scan"      # Run deep scan if issues found
    on_false: "triage_consensus"  # Otherwise just use triage results

  # Step 3a: Deep scan (only if escalated)
  - id: "deep_scan"
    kind: "role"
    role: "deep_scan"
    enabled: true
    timeout_seconds: 900

  # Step 3b: Triage-only consensus (if not escalated)
  - id: "triage_consensus"
    kind: "consensus"
    strategy: "majority"
    sources: ["triage"]

  # Step 4: Final consensus merging triage + deep scan (if both ran)
  - id: "final_consensus"
    kind: "consensus"
    strategy: "weighted"
    sources: ["triage", "deep_scan"]
    enabled: true
