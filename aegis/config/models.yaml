# Model Configuration for Aegis
# Defines available models, parsers, and pipeline configurations

models:
  # Ollama Models (discovered dynamically, configured here for defaults)
  ollama:
    base_url: "http://localhost:11434"
    default_settings:
      temperature: 0.1
      max_tokens: 2048
    recommended_models:
      - name: "qwen2.5-coder:7b"
        roles: ["deep_scan", "judge"]
        parser: "json_schema"
      - name: "codellama:7b"
        roles: ["deep_scan"]
        parser: "json_schema"

  # HuggingFace Models (local)
  huggingface:
    models:
      - model_id: "hf:codebert_insecure"
        hf_model_id: "mrm8488/codebert-base-finetuned-detect-insecure-code"
        task_type: "text-classification"
        display_name: "CodeBERT Insecure Code Detector"
        roles: ["triage"]
        parser: "hf_classification"
        description: "Binary classifier for detecting potentially insecure code patterns"
        settings:
          device: "cpu"  # or "cuda"
        parser_config:
          positive_labels: ["LABEL_1", "VULNERABLE", "INSECURE"]
          negative_labels: ["LABEL_0", "SAFE", "SECURE"]
          threshold: 0.5
          severity_high_threshold: 0.85
          severity_medium_threshold: 0.65

      - model_id: "hf:codeastra_7b"
        hf_model_id: "rootxhacker/CodeAstra-7B"
        task_type: "text-generation"
        display_name: "CodeAstra 7B"
        roles: ["deep_scan"]
        parser: "json_schema"
        description: "Generative model for detailed code analysis and vulnerability detection"
        settings:
          device: "cpu"  # or "cuda"
          max_new_tokens: 512
          temperature: 0.1
          do_sample: true
        prompt_template: |
          Analyze the following code for security vulnerabilities.
          Return ONLY a JSON object with this structure:
          {{
            "findings": [
              {{
                "file_path": "{file_path}",
                "line_start": <number>,
                "line_end": <number>,
                "snippet": "<code snippet>",
                "category": "<vulnerability_type>",
                "severity": "high|medium|low|info",
                "description": "<detailed explanation>",
                "confidence": <0.0-1.0>
              }}
            ]
          }}

          Code to analyze:
          ```
          {code}
          ```

          JSON output:

parsers:
  - id: "json_schema"
    class: "aegis.models.parsers.json_schema.JSONSchemaParser"
    description: "Parses JSON-formatted findings from generative models"
    config: {}

  - id: "hf_classification"
    class: "aegis.models.parsers.hf_classification.HFTextClassificationParser"
    description: "Parses HuggingFace text-classification outputs"
    config:
      positive_labels: ["LABEL_1", "VULNERABLE", "INSECURE"]
      negative_labels: ["LABEL_0", "SAFE", "SECURE"]
      threshold: 0.5
      severity_high_threshold: 0.85
      severity_medium_threshold: 0.65

# Example pipeline configurations
pipelines:
  # Triage -> Deep Scan -> Judge
  full_scan:
    name: "Full Security Scan"
    steps:
      - role: "triage"
        model_id: "hf:codebert_insecure"  # Optional: explicit model, otherwise picks first available
        parser: "hf_classification"
        filter_threshold: 0.5  # Only deep scan if confidence > 0.5

      - role: "deep_scan"
        model_id: "hf:codeastra_7b"  # or "ollama:qwen2.5-coder"
        parser: "json_schema"
        only_if_suspicious: true  # Only run if triage found issues

      - role: "judge"
        model_id: "ollama:qwen2.5-coder"
        parser: "json_schema"
        purpose: "final_verdict"  # Assess severity and consolidate findings

  # Quick triage only
  triage_only:
    name: "Quick Triage"
    steps:
      - role: "triage"
        parser: "hf_classification"

  # Deep scan only (skip triage)
  deep_scan_only:
    name: "Deep Scan Only"
    steps:
      - role: "deep_scan"
        parser: "json_schema"
