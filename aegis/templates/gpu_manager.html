{% extends "base.html" %}
{% block title %}GPU Runtime Manager - Aegis{% endblock %}

{% block content %}
<div class="container py-5" style="max-width: 1200px;">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h4 class="fw-bold text-light font-monospace mb-1">
        <i class="bi bi-gpu-card me-2 text-primary"></i>GPU Runtime Manager
      </h4>
      <p class="text-secondary small mb-0">Manage model loading, VRAM usage, and warmup operations</p>
    </div>
    <div class="d-flex gap-2">
      <button type="button" class="btn btn-outline-secondary font-monospace rounded-0"
              id="refreshAllBtn" title="Refresh all status">
        <i class="bi bi-arrow-clockwise me-1"></i> REFRESH
      </button>
      <button type="button" class="btn btn-outline-danger font-monospace rounded-0"
              id="clearAllModelsBtn" title="Unload all models from GPU">
        <i class="bi bi-trash me-1"></i> CLEAR ALL
      </button>
    </div>
  </div>

  <!-- VRAM Overview Card -->
  <div class="card bg-panel border-subtle shadow-sm mb-4">
    <div class="card-body p-4">
      <div class="row align-items-center">
        <div class="col-md-4">
          <div class="d-flex align-items-center gap-3">
            <div class="rounded-circle bg-primary bg-opacity-10 p-3">
              <i class="bi bi-memory text-primary fs-4"></i>
            </div>
            <div>
              <div class="text-secondary small font-monospace text-uppercase">GPU Memory</div>
              <div class="fs-4 fw-bold text-light" id="vramUsageText">-- / -- GB</div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="progress bg-black rounded-0" style="height: 24px;">
            <div id="vramProgressBar" class="progress-bar bg-primary" style="width: 0%">
              <span class="font-monospace small" id="vramPercentText">0%</span>
            </div>
          </div>
        </div>
        <div class="col-md-2 text-end">
          <span id="loadedModelsCount" class="badge bg-primary bg-opacity-10 text-primary font-monospace rounded-0 fs-6">
            0 LOADED
          </span>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <!-- Loaded Models -->
    <div class="col-lg-6">
      <div class="card bg-panel border-subtle shadow-sm h-100">
        <div class="card-header bg-transparent border-bottom border-subtle py-3">
          <div class="d-flex justify-content-between align-items-center">
            <span class="fw-bold text-uppercase text-success font-monospace small">
              <i class="bi bi-check-circle me-2"></i>Loaded Models
            </span>
          </div>
        </div>
        <div class="card-body p-3">
          <div id="loadedModelsList" class="d-flex flex-column gap-2" style="max-height: 400px; overflow-y: auto;">
            <div class="text-muted small font-monospace text-center py-5">
              <i class="bi bi-gpu-card fs-1 d-block mb-2 opacity-25"></i>
              NO_MODELS_LOADED
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Available Models for Warmup -->
    <div class="col-lg-6">
      <div class="card bg-panel border-subtle shadow-sm h-100">
        <div class="card-header bg-transparent border-bottom border-subtle py-3">
          <div class="d-flex justify-content-between align-items-center">
            <span class="fw-bold text-uppercase text-warning font-monospace small">
              <i class="bi bi-lightning me-2"></i>Warmup Queue
            </span>
            <span class="badge bg-warning bg-opacity-10 text-warning font-monospace rounded-0 small">
              LOCAL MODELS ONLY
            </span>
          </div>
        </div>
        <div class="card-body p-3">
          <p class="text-secondary small mb-3">
            Pre-load models to GPU memory for faster scanning. Click a model to warm it up.
          </p>
          <div id="warmupModelsList" class="d-flex flex-wrap gap-2" style="max-height: 300px; overflow-y: auto;">
            <div class="text-muted small font-monospace text-center w-100 py-4">
              <div class="spinner-border spinner-border-sm text-secondary me-2" role="status"></div>
              LOADING...
            </div>
          </div>

          <!-- Warmup Progress -->
          <div id="warmupProgressContainer" class="d-none mt-4 p-3 bg-black bg-opacity-25 rounded-1">
            <div class="d-flex align-items-center gap-3 mb-2">
              <div class="spinner-border spinner-border-sm text-warning" role="status"></div>
              <span id="warmupProgressText" class="font-monospace small text-warning">WARMING_UP...</span>
            </div>
            <div class="progress bg-black rounded-0" style="height: 6px;">
              <div id="warmupProgressBar" class="progress-bar bg-warning progress-bar-striped progress-bar-animated" style="width: 0%"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- System Info -->
  <div class="card bg-panel border-subtle shadow-sm mt-4">
    <div class="card-header bg-transparent border-bottom border-subtle py-3">
      <span class="fw-bold text-uppercase text-secondary font-monospace small">
        <i class="bi bi-info-circle me-2"></i>System Information
      </span>
    </div>
    <div class="card-body p-3">
      <div class="row g-3">
        <div class="col-md-4">
          <div class="p-3 bg-surface rounded-1 border border-subtle">
            <div class="text-secondary small font-monospace mb-1">CUDA Available</div>
            <div id="cudaStatus" class="text-light font-monospace">Checking...</div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="p-3 bg-surface rounded-1 border border-subtle">
            <div class="text-secondary small font-monospace mb-1">PyTorch Version</div>
            <div id="pytorchVersion" class="text-light font-monospace">--</div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="p-3 bg-surface rounded-1 border border-subtle">
            <div class="text-secondary small font-monospace mb-1">Last Updated</div>
            <div id="lastUpdated" class="text-light font-monospace">--</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let cachedModels = [];
let refreshInterval = null;

document.addEventListener('DOMContentLoaded', function() {
  loadRuntimeStatus();
  loadAvailableModels();

  // Auto-refresh every 5 seconds
  refreshInterval = setInterval(loadRuntimeStatus, 5000);

  // Button handlers
  document.getElementById('refreshAllBtn')?.addEventListener('click', () => {
    loadRuntimeStatus();
    loadAvailableModels();
  });

  document.getElementById('clearAllModelsBtn')?.addEventListener('click', clearAllModels);
});

async function loadRuntimeStatus() {
  try {
    const response = await fetch('/api/models/runtime/loaded');
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    const data = await response.json();
    updateRuntimeUI(data);
    document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
  } catch (error) {
    console.error('Error loading runtime status:', error);
    document.getElementById('loadedModelsCount').textContent = 'ERROR';
  }
}

function updateRuntimeUI(data) {
  const loadedModels = data.models || [];
  const gpuInfo = data.gpu || {};
  const usedMb = gpuInfo.used_vram_mb || data.total_vram_mb || 0;
  const totalMb = gpuInfo.total_vram_mb || 8192; // Fallback to 8GB if not detected

  // Update count badge
  const countBadge = document.getElementById('loadedModelsCount');
  if (countBadge) {
    countBadge.textContent = `${loadedModels.length} LOADED`;
    countBadge.className = `badge font-monospace rounded-0 fs-6 ${loadedModels.length > 0 ? 'bg-success text-white' : 'bg-primary bg-opacity-10 text-primary'}`;
  }

  // Update VRAM display with actual GPU info
  const percentage = totalMb > 0 ? Math.min((usedMb / totalMb) * 100, 100) : 0;

  const vramProgress = document.getElementById('vramProgressBar');
  const vramUsage = document.getElementById('vramUsageText');
  const vramPercent = document.getElementById('vramPercentText');

  if (vramProgress) {
    vramProgress.style.width = `${percentage}%`;
    vramProgress.className = `progress-bar ${percentage > 80 ? 'bg-danger' : percentage > 50 ? 'bg-warning' : 'bg-primary'}`;
  }

  if (vramUsage) {
    const usedGb = (usedMb / 1024).toFixed(1);
    const totalGb = (totalMb / 1024).toFixed(1);
    vramUsage.textContent = `${usedGb} / ${totalGb} GB`;
  }

  if (vramPercent) {
    vramPercent.textContent = `${Math.round(percentage)}%`;
  }

  // Update CUDA status
  const cudaStatus = document.getElementById('cudaStatus');
  if (cudaStatus) {
    if (gpuInfo.available) {
      cudaStatus.innerHTML = `<span class="text-success"><i class="bi bi-check-circle me-1"></i>${gpuInfo.gpu_name || 'Available'}</span>`;
    } else {
      cudaStatus.innerHTML = `<span class="text-warning"><i class="bi bi-x-circle me-1"></i>Not Available</span>`;
    }
  }

  // Update loaded models list
  const loadedList = document.getElementById('loadedModelsList');
  if (loadedList) {
    if (loadedModels.length === 0) {
      loadedList.innerHTML = `
        <div class="text-muted small font-monospace text-center py-5">
          <i class="bi bi-gpu-card fs-1 d-block mb-2 opacity-25"></i>
          NO_MODELS_LOADED
        </div>`;
    } else {
      loadedList.innerHTML = loadedModels.map(model => `
        <div class="d-flex justify-content-between align-items-center p-3 bg-surface rounded-1 border border-subtle">
          <div class="d-flex align-items-center gap-3">
            <i class="bi bi-gpu-card text-success fs-5"></i>
            <div>
              <div class="font-monospace text-light">${escapeHtml(model.model_id)}</div>
              <div class="font-monospace extra-small text-secondary">${model.model_name || '--'}</div>
            </div>
          </div>
          <div class="d-flex align-items-center gap-3">
            <span class="badge bg-dark font-monospace rounded-0">${model.device || 'GPU'}</span>
            <span class="font-monospace small text-secondary">${model.vram_mb ? Math.round(model.vram_mb) + ' MB' : '--'}</span>
            <button type="button" class="btn btn-sm btn-outline-danger rounded-0"
                    onclick="unloadModel('${escapeHtml(model.model_id)}')" title="Unload model">
              <i class="bi bi-x-lg"></i>
            </button>
          </div>
        </div>
      `).join('');
    }
  }

  // Update warmup list with loaded status
  updateWarmupListStatus(loadedModels.map(m => m.model_id));
}

async function loadAvailableModels() {
  const warmupList = document.getElementById('warmupModelsList');
  if (!warmupList) return;

  try {
    const response = await fetch('/api/models/registry?status=registered');
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    const data = await response.json();

    cachedModels = Array.isArray(data.models) ? data.models :
      (Array.isArray(data) ? data : (Array.isArray(data.data) ? data.data : []));

    updateWarmupListStatus([]);
  } catch (error) {
    console.error('Error loading models:', error);
    warmupList.innerHTML = '<div class="text-danger small font-monospace text-center w-100 py-4">ERROR_LOADING_MODELS</div>';
  }
}

function updateWarmupListStatus(loadedModelIds = []) {
  const warmupList = document.getElementById('warmupModelsList');
  if (!warmupList || cachedModels.length === 0) return;

  // Filter to only show HuggingFace local models
  const localModels = cachedModels.filter(m => {
    const provider = m.provider_id || m.provider || m.providerId || '';
    return provider.toLowerCase().includes('hf_local') || provider.toLowerCase().includes('huggingface');
  });

  if (localModels.length === 0) {
    warmupList.innerHTML = `
      <div class="text-muted small font-monospace text-center w-100 py-4">
        <i class="bi bi-exclamation-circle fs-4 d-block mb-2 opacity-50"></i>
        NO_LOCAL_MODELS_REGISTERED<br>
        <span class="extra-small">Register HuggingFace models to enable warmup</span>
      </div>`;
    return;
  }

  warmupList.innerHTML = localModels.map(model => {
    const modelId = model.model_id || model.id || model.modelId || model.model_name;
    const label = model.display_name || model.displayName || model.model_name || model.name;
    const isLoaded = loadedModelIds.includes(modelId);

    return `
      <div class="warmup-chip cursor-pointer border border-subtle bg-surface px-3 py-2 rounded-1 d-flex align-items-center gap-2 transition-all user-select-none font-monospace small
           ${isLoaded ? 'border-success text-success loaded' : 'text-secondary hover-border-warning'}"
           onclick="${isLoaded ? '' : `warmupModel('${escapeHtml(modelId)}')`}"
           title="${isLoaded ? 'Already loaded' : 'Click to warmup'}"
           style="${isLoaded ? 'opacity: 0.7; cursor: default;' : 'cursor: pointer;'}">
        <i class="bi ${isLoaded ? 'bi-check-circle-fill' : 'bi-lightning'}"></i>
        ${escapeHtml(label.split('/').pop())}
      </div>
    `;
  }).join('');
}

async function warmupModel(modelId) {
  const progressContainer = document.getElementById('warmupProgressContainer');
  const progressText = document.getElementById('warmupProgressText');
  const progressBar = document.getElementById('warmupProgressBar');

  if (!progressContainer || !progressText || !progressBar) return;

  progressContainer.classList.remove('d-none');
  progressText.textContent = `WARMING_UP: ${modelId}...`;
  progressBar.style.width = '30%';
  progressBar.className = 'progress-bar bg-warning progress-bar-striped progress-bar-animated';

  try {
    const response = await fetch(`/api/models/${encodeURIComponent(modelId)}/warmup`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });

    progressBar.style.width = '70%';
    const data = await response.json();

    if (data.success) {
      progressBar.style.width = '100%';
      progressBar.className = 'progress-bar bg-success';
      progressText.innerHTML = `<i class="bi bi-check-circle me-1"></i> ${modelId} LOADED (${data.load_time_ms || 0}ms)`;

      setTimeout(() => {
        progressContainer.classList.add('d-none');
        progressBar.className = 'progress-bar bg-warning progress-bar-striped progress-bar-animated';
        loadRuntimeStatus();
      }, 2000);
    } else {
      throw new Error(data.error || 'Warmup failed');
    }
  } catch (error) {
    console.error('Warmup error:', error);
    progressBar.style.width = '100%';
    progressBar.className = 'progress-bar bg-danger';
    progressText.innerHTML = `<i class="bi bi-exclamation-triangle me-1"></i> ERROR: ${error.message}`;

    setTimeout(() => {
      progressContainer.classList.add('d-none');
      progressBar.className = 'progress-bar bg-warning progress-bar-striped progress-bar-animated';
    }, 3000);
  }
}

async function unloadModel(modelId) {
  try {
    const response = await fetch(`/api/models/${encodeURIComponent(modelId)}/unload`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });

    const data = await response.json();

    if (data.success) {
      loadRuntimeStatus();
    } else {
      console.error('Unload failed:', data.error);
      alert(`UNLOAD_ERROR: ${data.error}`);
    }
  } catch (error) {
    console.error('Unload error:', error);
    alert(`UNLOAD_ERROR: ${error.message}`);
  }
}

async function clearAllModels() {
  if (!confirm('CONFIRM: Unload all models from GPU?\nThis will free VRAM but require re-loading for next scan.')) {
    return;
  }

  try {
    const response = await fetch('/api/models/runtime/clear', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });

    const data = await response.json();

    if (data.success) {
      loadRuntimeStatus();
    } else {
      console.error('Clear failed:', data.error);
      alert(`CLEAR_ERROR: ${data.error}`);
    }
  } catch (error) {
    console.error('Clear error:', error);
    alert(`CLEAR_ERROR: ${error.message}`);
  }
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}
</script>

<style>
  .warmup-chip:hover:not(.loaded) {
    border-color: var(--bs-warning) !important;
    color: var(--bs-warning) !important;
  }

  .warmup-chip.loaded {
    background-color: rgba(25, 135, 84, 0.1) !important;
  }

  .extra-small {
    font-size: 0.75rem;
  }
</style>
{% endblock %}
